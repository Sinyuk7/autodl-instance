# autodl-instance

[![Python 3.10+](https://img.shields.io/badge/python-3.10+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

> ğŸš€ AutoDL äº‘ GPU å®ä¾‹ç¯å¢ƒé…ç½®å·¥å…·

ä¸“ä¸º [AutoDL](https://www.autodl.com/) äº‘ GPU å®ä¾‹è®¾è®¡ï¼Œå®ç° **Infrastructure as Code + User Data Roaming**ï¼ˆåŸºç¡€è®¾æ–½å³ä»£ç  + ç”¨æˆ·æ•°æ®æ¼«æ¸¸ï¼‰ã€‚

## âœ¨ ç‰¹æ€§

- **å¿«é€Ÿéƒ¨ç½²** - é€šè¿‡å°‘é‡å‘½ä»¤å®Œæˆ ComfyUI ç¯å¢ƒé…ç½®
- **ç¼“å­˜ç®¡ç†** - è‡ªåŠ¨å°†ç¼“å­˜é‡å®šå‘è‡³æ•°æ®ç›˜ï¼ŒèŠ‚çœç³»ç»Ÿç›˜ç©ºé—´
- **å¼€ç®±å³ç”¨** - é¦–æ¬¡è¿è¡Œè‡ªåŠ¨å®‰è£…æ‰€éœ€ä¾èµ–
- **æ— å¡åˆå§‹åŒ–** - æ”¯æŒåœ¨æ—  GPU æ¨¡å¼ä¸‹å®Œæˆç¯å¢ƒåˆå§‹åŒ–
- **æ¨¡å‹ç®¡ç†** - æ”¯æŒäº¤äº’å¼ä¸‹è½½ï¼Œè¯†åˆ« HuggingFace/CivitAI é“¾æ¥
- **æ•°æ®æ¼«æ¸¸** - å·¥ä½œæµã€èŠ‚ç‚¹å¿«ç…§ã€æ¨¡å‹è®°å½•è‡ªåŠ¨åŒæ­¥åˆ°ç§æœ‰ä»“åº“ï¼Œè·¨å®ä¾‹æ— ç¼è¿ç§»

## ğŸ“¦ å¿«é€Ÿå¼€å§‹

### 1. å…‹éš†é¡¹ç›®åˆ° AutoDL æ•°æ®ç›˜

```bash
cd /root/autodl-tmp
git clone https://github.com/Sinyuk7/autodl-instance.git
cd autodl-instance
```

### 2. ä¸€é”®åˆå§‹åŒ–ç¯å¢ƒ

```bash
chmod +x init.sh
./init.sh
```

è¿™å°†è‡ªåŠ¨å®Œæˆï¼š
- âœ… å®‰è£… `uv` æé€ŸåŒ…ç®¡ç†å™¨
- âœ… å®‰è£… `comfy-cli` å®˜æ–¹ CLI å·¥å…·
- âœ… å°† `.cache` ç›®å½•è¿ç§»è‡³æ•°æ®ç›˜ï¼ˆé¿å…ç³»ç»Ÿç›˜çˆ†æ»¡ï¼‰
- âœ… é…ç½® Git/SSH ç¯å¢ƒ
- âœ… éƒ¨ç½² ComfyUI + ComfyUI-Manager
- âœ… å®‰è£…é¢„è®¾çš„è‡ªå®šä¹‰èŠ‚ç‚¹
- âœ… åŒæ­¥ç”¨æˆ·é…ç½®å’Œå·¥ä½œæµ

> ğŸ’¡ **çœé’±æŠ€å·§**ï¼šå¯ä»¥åœ¨ã€Œæ— å¡æ¨¡å¼ã€ä¸‹å®Œæˆåˆå§‹åŒ–ï¼Œä¸‹è½½å®Œæˆåå…³æœºï¼Œå†ä»¥æœ‰å¡æ¨¡å¼å¯åŠ¨æœåŠ¡ã€‚

### 3. å¯åŠ¨ ComfyUI æœåŠ¡

```bash
start
```

### 4. å…³æœºå‰åŒæ­¥

```bash
bye
```

è‡ªåŠ¨ä¿å­˜è‡ªå®šä¹‰èŠ‚ç‚¹å¿«ç…§ã€æ¨¡å‹ä¸‹è½½è®°å½•ã€å·¥ä½œæµæ–‡ä»¶ä»¥åŠç”¨æˆ·é…ç½®ï¼Œç¡®ä¿ä¸‹æ¬¡å¼€æœºèƒ½å®Œæ•´è¿˜åŸå·¥ä½œç¯å¢ƒã€‚

---

## âŒ¨ï¸ å¿«æ·å‘½ä»¤

`./init.sh` å®Œæˆåï¼Œä»¥ä¸‹å…¨å±€å‘½ä»¤å¯ç›´æ¥åœ¨ç»ˆç«¯ä½¿ç”¨ï¼š

| å‘½ä»¤ | åŠŸèƒ½ |
|------|------|
| `start` | å¯åŠ¨ ComfyUI æœåŠ¡ (é™„åŠ  `--debug` å¯å¼€å¯è°ƒè¯•æ¨¡å¼) |
| `bye` | å…³æœºå‰åŒæ­¥ |
| `model` | æ¨¡å‹ä¸‹è½½ç®¡ç† |
| `turbo` | å¯ç”¨ AutoDL å­¦æœ¯åŠ é€Ÿï¼ˆåŠ é€Ÿ GitHub/HuggingFaceï¼‰ |

## âš™ï¸ å¯é€‰é…ç½®

æ‰€æœ‰é…ç½®å‡ä¸º**å¯é€‰**ï¼Œæœªé…ç½®çš„åŠŸèƒ½ä¼šè‡ªåŠ¨è·³è¿‡ã€‚é…ç½®æ–‡ä»¶åˆ†æ•£åœ¨å„æ¨¡å—ç›®å½•ä¸‹ï¼š

### Git å…å¯†æ¨é€

```bash
cd src/addons/git_config
cp manifest.yaml.example manifest.yaml
vim manifest.yaml
```

é…ç½® `user_name`ã€`user_email`ã€SSH å¯†é’¥åï¼Œå¯å¯ç”¨ç§æœ‰ä»“åº“çš„å…å¯†æ¨é€ã€‚

### API Tokenï¼ˆæ¨¡å‹ä¸‹è½½åŠ é€Ÿï¼‰

```bash
cd src/lib/download
cp secrets.yaml.example secrets.yaml
vim secrets.yaml
```

é…ç½® HuggingFace / CivitAI çš„ API Tokenï¼Œè§£é”éœ€è¦ç™»å½•çš„æ¨¡å‹ä¸‹è½½ã€‚

### æ•°æ®æ¼«æ¸¸ï¼ˆè·¨å®ä¾‹åŒæ­¥ï¼‰

ç¼–è¾‘ `src/addons/userdata/manifest.yaml`ï¼Œé…ç½® `userdata_repo` ä¸ºä½ çš„ç§æœ‰ Git ä»“åº“åœ°å€ï¼š

```yaml
userdata_repo: "git@github.com:username/my-comfyui-backup.git"
```

é…ç½®åï¼Œä½ çš„ç”¨æˆ·æ•°æ®å°†è‡ªåŠ¨åŒæ­¥ï¼š

| æ•°æ®ç±»å‹ | è¯´æ˜ |
|---------|------|
| å·¥ä½œæµ | ComfyUI ä¿å­˜çš„ `.json` å·¥ä½œæµæ–‡ä»¶ |
| èŠ‚ç‚¹å¿«ç…§ | ComfyUI-Manager ç”Ÿæˆçš„èŠ‚ç‚¹çŠ¶æ€å¿«ç…§ |
| æ¨¡å‹è®°å½• | å·²ä¸‹è½½æ¨¡å‹çš„æ¸…å• |
| ç”¨æˆ·é…ç½® | ComfyUI è®¾ç½®ã€èŠ‚ç‚¹åå¥½ç­‰ |

> å¦‚æœä¸é…ç½®ç§æœ‰ä»“åº“ï¼Œæ•°æ®ä¼šä¿å­˜åœ¨æœ¬åœ° `my-comfyui-backup` ç›®å½•ï¼Œä¸å½±å“æ­£å¸¸ä½¿ç”¨ã€‚

## ğŸ“¥ æ¨¡å‹ä¸‹è½½

### äº¤äº’å¼ä¸‹è½½

```bash
model download https://civitai.com/models/12345
model download https://huggingface.co/xxx/xxx/xxx.safetensors
```

è‡ªåŠ¨è¯†åˆ«æ¥æºï¼Œå¼•å¯¼ä½ ç¡®è®¤æ–‡ä»¶åã€é€‰æ‹©æ¨¡å‹ç±»å‹å’Œå­ç›®å½•ã€‚

### æŒ‰é¢„è®¾æ‰¹é‡ä¸‹è½½

é¢„è®¾å®šä¹‰åœ¨ `src/addons/models/manifest.yaml`ï¼Œä¸€é”®ä¸‹è½½å®Œæ•´å·¥ä½œæµæ‰€éœ€çš„å…¨éƒ¨æ¨¡å‹ï¼š

```bash
model download -p FLUX.2-klein-9B
```

`manifest.yaml` è¯­æ³•ç¤ºä¾‹ï¼š
```yaml
FLUX.2-klein-9B:
  - url: "https://huggingface.co/xxx/xxx.safetensors"
    type: "checkpoints"
  - url: "https://civitai.com/models/12345"
    type: "loras"
    name: "my_lora.safetensors"
```

å·²ä¸‹è½½çš„æ¨¡å‹è‡ªåŠ¨è·³è¿‡ï¼Œä¸ä¼šé‡å¤ä¸‹è½½ã€‚

### ç®¡ç†æ¨¡å‹

```bash
model types          # æŸ¥çœ‹å¯ç”¨çš„æ¨¡å‹ç±»å‹
model list           # åˆ—å‡ºå·²ä¸‹è½½çš„æ¨¡å‹
model status         # æŸ¥çœ‹ lock æ–‡ä»¶è®°å½•
model remove <name>  # åˆ é™¤æ¨¡å‹
model cache          # æŸ¥çœ‹ä¸‹è½½ç¼“å­˜å¤§å°
model cache clear    # æ¸…ç†å…¨éƒ¨ä¸‹è½½ç¼“å­˜
```

### ä¸‹è½½ç­–ç•¥

| URL æ¥æº | ä¸‹è½½å·¥å…· | ç‰¹ç‚¹ |
|---------|---------|------|
| HuggingFace | `huggingface_hub` + `hf_xet` | å®˜æ–¹ Hub APIï¼Œç‰ˆæœ¬æ„ŸçŸ¥ç¼“å­˜ï¼Œxet åˆ†å—å»é‡åŠ é€Ÿ |
| CivitAI | `aria2c` å¤šçº¿ç¨‹ | è‡ªåŠ¨è§£ææ¨¡å‹ä¿¡æ¯ï¼Œæ”¯æŒ API Token |
| ç›´é“¾ | `aria2c` å¤šçº¿ç¨‹ | 32 çº¿ç¨‹å¹¶å‘ï¼Œæ–­ç‚¹ç»­ä¼  |

## ğŸ”§ å¸¸è§é—®é¢˜

### 1. å®‰è£…å¡ä½æ— å“åº”

**åŸå› **ï¼šä¹‹å‰ä¸­æ–­çš„è¿›ç¨‹ï¼ˆCtrl+Z / Ctrl+Cï¼‰æŒæœ‰ uv é”æ–‡ä»¶ã€‚

**è§£å†³**ï¼š
```bash
pkill -9 -f "python.*src.main"
rm -f /tmp/uv-*.lock
./init.sh
```

### 2. PyTorch ä¸‹è½½é€Ÿåº¦æ…¢

æ­£å¸¸ç°è±¡ã€‚PyTorch ä½“ç§¯è¾ƒå¤§ä¸”å®˜æ–¹æºåœ¨å›½å¤–ï¼Œè€å¿ƒç­‰å¾…å³å¯ã€‚ä¸‹è½½å®Œæˆåä¼šç¼“å­˜åˆ°æ•°æ®ç›˜ï¼Œä¸‹æ¬¡å¼€æœºæ— éœ€é‡æ–°ä¸‹è½½ã€‚

### 3. SSH å¯†é’¥éœ€è¦æ‰‹åŠ¨æ·»åŠ åˆ° GitHub

**ç°è±¡**ï¼šæç¤º `[ACTION REQUIRED] è¯·å°†ä»¥ä¸‹å…¬é’¥æ·»åŠ åˆ° GitHub è´¦æˆ·`

**è§£å†³**ï¼šå¤åˆ¶æç¤ºä¸­çš„å…¬é’¥ï¼Œè®¿é—® https://github.com/settings/keys æ·»åŠ ã€‚

> æ›´å¥½çš„æ–¹å¼ï¼šåœ¨ `src/addons/git_config/manifest.yaml` ä¸­é…ç½®æœ¬åœ°å·²æœ‰çš„ SSH å¯†é’¥ï¼Œé¿å…æ¯æ¬¡æ–°å»ºå®ä¾‹éƒ½è¦é‡æ–°æ·»åŠ ã€‚

## ğŸ‘¨â€ğŸ’» å¼€å‘è€…

å¦‚æœä½ æƒ³äº†è§£é¡¹ç›®æ¶æ„æˆ–å‚ä¸å¼€å‘ï¼Œè¯·å‚é˜… [CONTRIBUTING.md](CONTRIBUTING.md)ã€‚

## ğŸ“„ License

[MIT License](LICENSE)

---

**Made with â¤ï¸ for AutoDL users**